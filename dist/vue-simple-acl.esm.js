import{reactive as e,computed as r}from"vue";const t=e=>{let r=null;let t=e.toString().match(/\(([a-z0-9 ,$_\+\*\-\/]+)\)/im);if(t&&Array.isArray(t)&&t[0]){let e=t[0];e=e.replace(/\(|\)|[ ]/g,"");let i=e.split(",");i.length>0&&(r=i)}return r},i=e=>"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1),o=e({registeredUser:{},registeredRules:{},options:{}}),a=e=>{u(e.user)?o.registeredUser=e.user():o.registeredUser=e.user,e.rules&&"function"==typeof e.rules&&e.rules(),o.options=e},s=(e,r)=>{o.registeredRules.hasOwnProperty(e)?console.warn(`:::VueSimpleACL::: Duplicate ACL Rule '${e}' defined. Only the first defined rule will be evaluated.`):o.registeredRules[e]=r},n=(e,r)=>{"string"==typeof e?s(e,r):"object"==typeof e&&Array.isArray(e)&&Object.values(e).forEach((e=>{s(e,r)}))},l=(e,r,i)=>{try{return"function"==typeof e&&("object"!=typeof i||Array.isArray(i)?"object"==typeof i&&Array.isArray(i)?e(o.registeredUser,...i):e(o.registeredUser):e(o.registeredUser,i))}catch(i){let o=t(e),a=null;o&&Array.isArray(o)&&(o.shift(),a=o.join(", "));let s=':::VueSimpleACL::: The defined ACL Rule for "'+r+'" require some argument(s) or data object to be specified for matching.';return s+="\n\nCheck the file containing your defineAclRules((setRule) => {...}); declarations",s+="\n\nExamples:",o&&o.length<=0?(s+=`\nv-can:${r}`,s+=`\nv-can="'${r}'"`,s+=`\n$can('${r}')`):o&&1===o.length?(s+=`\nv-can:${r}="${a}"`,s+=`\nv-can="'${r}', ${a}"`,s+=`\n$can('${r}', ${a})`):(s+=`\nv-can:${r}="[${a}]"`,s+=`\nv-can="'${r}', [${a}]"`,s+=`\n$can('${r}', [${a}])`),console.error(s),console.error(i),!1}},c=({abilities:e,args:r,any:t=!1})=>{if(e&&"string"==typeof e){if(o.registeredRules.hasOwnProperty(e)){let t=o.registeredRules[e];return l(t,e,r)}}else if("object"==typeof e&&Array.isArray(e)){let r=!1,i=!1,a=0,s=0;return e.forEach((e=>{if(o.registeredRules.hasOwnProperty(e.abilities)){let s=o.registeredRules[e.abilities];i=l(s,e.abilities,e.args),!0===t&&i&&(r=!0),a++}})),a>0&&a===s&&(r=!0),r}return!1},m=({abilities:e,args:r,any:t=!1})=>{const i=r,o=t;let a=!1;if(e)a=c(i?{abilities:e,args:i}:{abilities:e});else if(i&&"string"==typeof i)a=c({abilities:i});else if(i&&null!==i&&"object"==typeof i){if(2!==(Array.isArray(i)?i.length:Object.keys(i).length)||"string"!=typeof i[0]||"object"!=typeof i[1]||Array.isArray(i[1])){let e=[],r=[];i.forEach((r=>{if(r&&"string"==typeof r)e.push({abilities:r});else if(r&&"object"==typeof r){let t=null,i=[];r.forEach((e=>{e&&!t&&"string"==typeof e?t=e:i.push(e)})),t&&e.push({abilities:t,args:i})}})),a=c({abilities:e,args:r,any:o})}else a=c({abilities:i[0],args:i[1]})}return a},p=({abilities:e,args:r,any:t=!1})=>e&&"string"==typeof e?m({abilities:e,args:r,any:t}):"object"==typeof e?m({abilities:null,args:e,any:t}):(console.warn(":::VueSimpleACL::: Invalid ACL arguments specified."),!1),y=(e,r)=>p({abilities:e,args:r,any:!1}),g=(e,r)=>!p({abilities:e,args:r,any:!1}),f=(e,r)=>p({abilities:e,args:r,any:!0}),u=e=>"function"==typeof e&&e()instanceof Promise,d=(e,s)=>{const n=!!e.config.globalProperties,l={...{user:Object.create(null),rules:null,router:null,onDeniedRoute:"/",directiveName:"can",helperName:"$can",enableSematicAlias:!0},...s};l.directiveName&&"string"==typeof l.directiveName&&l.directiveName.startsWith("v-")&&(l.directiveName=l.directiveName.substr(2,l.directiveName.length)),l.helperName&&"string"==typeof l.helperName&&"$"!==l.helperName.charAt(0)&&(l.helperName="$"+l.helperName),u(l.user)||a(l);const c=(e,r,t)=>{const i=r.arg,o=r.value,a=r.modifiers,s=!!a.any,n=!!a.not,l=!!a.readonly,c=!(!a.disable&&!a.disabled);!a.hide&&a.hidden;m({abilities:i,args:o,any:s})?n&&(e.style.display="none"):n||(c?e.disabled=!0:l?e.readOnly=!0:e.style.display="none")},p=(e,r,t)=>{e.directive(`${r}`,{mounted(e,r,t){c(e,r)},updated(e,r,t){c(e,r)}})},d=(e,r,t,o)=>{t?o?(e.config.globalProperties.$acl||(e.config.globalProperties.$acl={}),e.config.globalProperties.$acl[r]=(e,r)=>y(e,r),e.config.globalProperties.$acl[`all${i(r)}`]=(e,r)=>y(e,r),e.config.globalProperties.$acl[`not${i(r)}`]=(e,r)=>g(e,r),e.config.globalProperties.$acl[`any${i(r)}`]=(e,r)=>f(e,r)):(e.config.globalProperties[r]=(e,r)=>y(e,r),e.config.globalProperties[r].all=(e,r)=>y(e,r),e.config.globalProperties[r].not=(e,r)=>g(e,r),e.config.globalProperties[r].any=(e,r)=>f(e,r)):o?(e.prototype.$acl||(e.prototype.$acl={}),e.prototype.$acl[r]=(e,r)=>y(e,r),e.prototype.$acl[`all${i(r)}`]=(e,r)=>y(e,r),e.prototype.$acl[`not${i(r)}`]=(e,r)=>g(e,r),e.prototype.$acl[`any${i(r)}`]=(e,r)=>f(e,r)):(e.prototype[r]=(e,r)=>y(e,r),e.prototype[r].all=(e,r)=>y(e,r),e.prototype[r].not=(e,r)=>g(e,r),e.prototype[r].any=(e,r)=>f(e,r))};if(p(e,`${l.directiveName}`),l.enableSematicAlias&&(p(e,"permission"),p(e,"permissions"),p(e,"role"),p(e,"roles"),p(e,"role-or-permission"),p(e,"role-or-permissions")),d(e,`${l.helperName}`,n,!1),l.enableSematicAlias&&(d(e,"can",n,!0),d(e,"permission",n,!0),d(e,"permissions",n,!0),d(e,"role",n,!0),d(e,"roles",n,!0),d(e,"roleOrPermission",n,!0),d(e,"roleOrPermissions",n,!0),n?(e.config.globalProperties.$acl||(e.config.globalProperties.$acl={}),e.config.globalProperties.$acl.user=r((()=>o.registeredUser)).value,e.config.globalProperties.$acl.getUser=()=>o.registeredUser):(e.prototype.$acl||(e.prototype.$acl={}),e.prototype.$acl.user=r((()=>o.registeredUser)).value,e.prototype.$acl.getUser=()=>o.registeredUser)),l.router){const e=(e,r,t,i)=>{if(i)t();else{let i=l.onDeniedRoute;e.meta&&e.meta.onDeniedRoute&&(i=e.meta.onDeniedRoute),t("object"==typeof i?i:"$from"===i?r:{path:`${i}`,replace:!0})}},r=(r,i,a)=>{if(r.meta&&(r.meta.can||r.meta.permission||r.meta.role||r.meta.roleOrPermission)){const s=r.meta.can||r.meta.permission||r.meta.role||r.meta.roleOrPermission;let n=!1;if("function"==typeof s){const e=t(s);n=Array.isArray(e)&&4===e.length?s(r,i,y,o.registeredUser):s(r,i,y)}else n=y(s);n||e(r,i,a,n)}if(r.meta&&(r.meta.canAll||r.meta.allCan||r.meta.allPermission||r.meta.allRole||r.meta.allRoleOrPermission)){const s=r.meta.canAll||r.meta.allCan||r.meta.allPermission||r.meta.allRole||r.meta.allRoleOrPermission;let n=!1;if("function"==typeof s){const e=t(s);n=Array.isArray(e)&&4===e.length?s(r,i,y,o.registeredUser):s(r,i,y)}else n=y(s);n||e(r,i,a,n)}if(r.meta&&(r.meta.cannot||r.meta.canNot||r.meta.notCan||r.meta.notPermission||r.meta.notRole||r.meta.notRoleOrPermission)){const s=r.meta.cannot||r.meta.canNot||r.meta.notCan||r.meta.notPermission||r.meta.notRole||r.meta.notRoleOrPermission;let n=!1;if("function"==typeof s){const e=t(s);n=Array.isArray(e)&&4===e.length?s(r,i,g,o.registeredUser):s(r,i,g)}else n=g(s);n||e(r,i,a,n)}if(r.meta&&(r.meta.canAny||r.meta.anyCan||r.meta.anyPermission||r.meta.anyRole||r.meta.anyRoleOrPermission)){const s=r.meta.canAny||r.meta.anyCan||r.meta.anyPermission||r.meta.anyRole||r.meta.anyRoleOrPermission;let n=!1;if("function"==typeof s){const e=t(s);n=Array.isArray(e)&&4===e.length?s(r,i,f,o.registeredUser):s(r,i,f)}else n=f(s);n||e(r,i,a,n)}e(r,i,a,!0)};l.router.beforeEach(((e,t,i)=>{u(l.user)?l.user().then((o=>{l.user=o,a(l),r(e,t,i)})).catch((e=>{console.warn(":::VueSimpleACL::: Error while processing/retrieving 'user' data with the Asynchronous function.")})):r(e,t,i)}))}else u(l.user)&&console.error(":::VueSimpleACL::: Instance of vue-router is required to define 'user' retrieved from a promise or Asynchronous function.")},b=e=>({install:(r,t={})=>{d(r,{...t,...e})}}),$=e=>{"function"==typeof e&&e(n)},h=()=>{let t={};return t.user=r((()=>o.registeredUser)).value,t.getUser=()=>o.registeredUser,t.can=y,t.can.not=g,t.can.any=f,t.notCan=g,t.canNot=g,t.cannot=g,t.anyCan=f,t.permission=y,t.allPermission=y,t.notPermission=g,t.anyPermission=f,t.permission.not=g,t.permission.any=f,t.role=y,t.allRole=y,t.notRole=g,t.anyRole=f,t.role.not=g,t.role.any=f,t.roleOrPermission=y,t.allRoleOrPermission=y,t.notRoleOrPermission=g,t.anyRoleOrPermission=f,t.roleOrPermission.not=g,t.roleOrPermission.any=f,e(t)},A={install:(e,r)=>d(e,r)};"undefined"!=typeof window&&window.Vue&&window.Vue.use(A);export{b as createAcl,$ as defineAclRules,h as useAcl};
